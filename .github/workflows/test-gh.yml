name: test-gh
on:
  push:
    branches:
      - develop
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'examples/**'
  pull_request:
    types: [opened, reopened, synchronize]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'examples/**'

jobs:
  test-all:
    name: Test GH
    runs-on: ubuntu-latest
    steps:
    - name: Set up Go 1.x
      uses: actions/setup-go@v2
      with:
        go-version: "1.17"
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
      with:
        path: src/github.com/${{ github.repository }}
        fetch-depth: 0
    - name: Install Carvel Tools
      uses: vmware-tanzu/carvel-setup-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        only: ytt, kapp
    - name: Run Tests
      env:
        DOCKERHUB_USERNAME: k8slt
        DOCKERHUB_ACCESS_TOKEN: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
      run: |
        set -e -x

        minikube start --driver=docker --wait=all
        eval $(minikube docker-env --shell=bash)

        docker buildx create minikube --use --driver=kubernetes

        # when this workflow runs of a pull request based on a fork, secrets are unavailable
        # https://docs.github.com/en/actions/reference/encrypted-secrets#using-encrypted-secrets-in-a-workflow
        # if [[ "${DOCKERHUB_ACCESS_TOKEN}" != "" ]]; then
        #   # Authenticate to DockerHub to avoid test failures due to rate limiting
        #   # ... for builders using Docker
        #   set +x
        #   echo "${DOCKERHUB_ACCESS_TOKEN}" | docker login --username "${DOCKERHUB_USERNAME}" --password-stdin
        #   # ... for kubectl-buildkit
        #   minikube kubectl --ssh=true -- create secret docker-registry buildkit \
        #     --docker-username="${DOCKERHUB_USERNAME}" \
        #     --docker-password="${DOCKERHUB_ACCESS_TOKEN}"
        #   # ... for any other service account that pulls images from DockerHub
        #   minikube kubectl --ssh=true -- create secret docker-registry dockerhub-credentials \
        #     --docker-username="${DOCKERHUB_USERNAME}" \
        #     --docker-password="${DOCKERHUB_ACCESS_TOKEN}"
        #   set -x
        # else
        #   echo "No DockerHub Access Token set; skipping Docker authentication. There may be rate limit errors."
        # fi

        mkdir -p /tmp/bin
        export PATH=/tmp/bin:$PATH

        wget -O- -nv https://github.com/vmware-tanzu/buildkit-cli-for-kubectl/releases/download/v0.1.0/linux-refs.tags.v0.1.0.tgz > /tmp/kb-cli.tgz
        tar xzvf /tmp/kb-cli.tgz -C /tmp/bin

        wget -O- -nv https://github.com/buildpacks/pack/releases/download/v0.8.1/pack-v0.8.1-linux.tgz > /tmp/pack-cli.tgz
        tar xzvf /tmp/pack-cli.tgz -C /tmp/bin

        wget -O- -nv https://github.com/google/ko/releases/download/v0.8.0/ko_0.8.0_Linux_x86_64.tar.gz > /tmp/ko.tgz
        tar xzvf /tmp/ko.tgz -C /tmp/bin

        wget -O- -nv https://github.com/bazelbuild/bazel/releases/download/4.2.0/bazel-4.2.0-linux-x86_64 > /tmp/bin/bazel
        chmod +x /tmp/bin/bazel

        cd "src/github.com/${{ github.repository }}"

        export KBLD_E2E_SKIP_WHEN_HTTP_REGISTRY=true
        ./hack/test-all-minikube-local-registry.sh
        ./hack/build-binaries.sh
